<!DOCTYPE html>
<html>

<head>
  <title>Gnark ZkCensus-Wasm prover test | Vocdoni</title>
  <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
  <style>
    body {
      font-family: monospace;
      background-color: black;
      color: lime;
      padding: 1rem;
    }

    #log {
      overflow: auto;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <h1>
    Gnark ZkCensus-Wasm prover test
  </h1>

  <pre>‚ö†Ô∏èüöß This repository is currently a <b>proof of concept</b>. üöß‚ö†Ô∏è</pre>

  <div id="log"></div>

  
  <script type="module">
  import witnessUrl from "url:./artifacts/zkcensus.witness";
  import wasmUrl from "url:./artifacts/g16_prover.wasm";
  import { init, WASI } from '@wasmer/wasi';

    var glog = console.log;
    console.log = function (msg) {
      glog(msg);
      let node = document.createElement("div");
      let timestamp = new Date().toISOString();
      node.innerHTML = `[${timestamp}] ${ansiToHTML(msg)}`;
      document.getElementById("log").appendChild(node);
    };

    function ansiToHTML(ansi) {
      const colors = {
        "30": "black",
        "31": "red",
        "32": "lime",
        "33": "yellow",
        "34": "blue",
        "35": "magenta",
        "36": "cyan",
        "37": "white",
        "90": "gray"
      };
      return ansi.replace(/\u001b\[(\d+);?(\d+)?m(.*?)\u001b\[0m/g, (match, fg, bg, text) => {
        const fgColor = colors[fg];
        const bgColor = colors[bg];
        return `<span style="color: ${fgColor};${bgColor ? ` background-color: ${bgColor};` : ''}">${text}</span>`;
      });
    }

    (async () => {
      let start = Date.now();
      console.log("reading artifacts...");
      let resWitness = await fetch("./artifacts/zkcensus.witness");
      let witnessBuff = await resWitness.arrayBuffer();
      let witness = new Uint8Array(witnessBuff);
      
      console.log("loading go env and wasm...");
      await init();
    
      try {
        console.log("reading artifacts...");

        let resWitness = await fetch(witnessUrl);
        let witnessBuff = await resWitness.arrayBuffer();
        let witness = new Uint8Array(witnessBuff);

        console.log("downloading data and generating proof...");

        // Instantiate the WASI instance
        console.log("loading go env and wasm...");
        let wasi = new WASI({
          args: [  
            `[${witness.join(",")}]`,
          ],
          env: {},
          bindings: {
            ...WASI.defaultBindings,
          }
        });

        // Fetch our Wasm File
        console.log("fetching wasm...");
        let response = await fetch(wasmUrl)
        let wasmBytes = new Uint8Array(await response.arrayBuffer())

        // Instantiate the WebAssembly file
        console.log("instantiating wasm...");
        let wasmModule = await WebAssembly.compile(wasmBytes);

        let instance = await WebAssembly.instantiate(wasmModule, {...wasi.getImports(wasmModule)});

        // Start the WebAssembly WASI instance!
        wasi.start(instance);
        instance.exports.generateProof(witness);

        let stdout = wasi.getStdoutString(); // Get the contents of stdout
        console.log(`Standard Output: ${stdout}`); // Write stdout data to the DOM
      } catch (error) {
        console.error(error);
      }
    })();
  </script>

</body>

</html>
